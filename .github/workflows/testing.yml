name: Terraform Demo
on: 
  push:
    branches:
      - 'master'
  issue_comment:
    types: [created]
permissions:
  id-token: write #this is imp to set the token as not have this will not allow to set assumed role
  contents: read
  pull-requests: write




jobs:
    Commented:
      name: PR comment
      if: ${{ github.event.issue.pull_request && (github.event.comment.body == 'tf plan' || github.event.comment.body == 'tf apply') && github.event.action != 'closed'}}
      env: 
        NUMBER: ${{ github.event.issue.number }}
      runs-on: ubuntu-latest
      steps:
        - name: Print PR Number 
          run: echo "A comment on PR $NUMBER"
      
        - name: Download PR
          uses: actions/checkout@v3
          with:
            ref: "refs/pull/${{ github.event.issue.number }}/merge"
        - name: Configure AWS credentials from Test account
          uses: aws-actions/configure-aws-credentials@v3
          with:
            role-to-assume: ${{ secrets.ASSUMED_ROLE }}
            aws-region: ${{ env.AWS_REGION }}

        - name: Checkout Repository
          uses: actions/checkout@v2
  
        - name: Terraform Init
          run: terraform init
            
        - name: Terraform Plan
          run: terraform plan

          

            # - name: Terraform Apply
            #   run: terraform apply -auto-approve